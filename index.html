<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Invoice Generator</title>
    <link rel="icon" type="image/png" href="https://malkitsweetsandcatering.com/img/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .view { display: none; }
        .view.active { display: block; }
        #edit-vendor-modal { display: none; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .header-container {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            padding: 1.25rem 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #E2E8F0;
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .header-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            background: white;
            padding: 0.375rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .header-text {
            text-align: left;
        }
        .header-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: #1E293B;
            margin: 0;
            letter-spacing: -0.025em;
            line-height: 1.2;
        }
        .header-subtitle {
            font-size: 0.875rem;
            color: #64748B;
            margin: 0.25rem 0 0;
            font-weight: 400;
        }
        .list-container {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        .list-container::-webkit-scrollbar {
            width: 8px;
        }
        .list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .list-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .list-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .action-buttons {
            display: flex;
            gap: 1rem;
        }
        .action-buttons button {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            text-align: center;
            transition: all 0.2s ease;
        }
        #delete-draft-btn {
            background-color: #EF4444;
            color: white;
        }
        #download-draft-btn {
            background-color: #10B981;
            color: white;
        }
        #save-draft-btn {
            background-color: #6B7280;
            color: white;
        }
        #generate-btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            background-color: #4F46E5;
            color: white;
            border-radius: 0.375rem;
        }
        .action-buttons button:hover {
            opacity: 0.9;
        }
        .invoice-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #F9FAFB;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }
        .invoice-list-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }
        .invoice-list-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            max-width: 60%;
        }
        .invoice-list-header {
            font-weight: 600;
            color: #1F2937;
            margin: 0;
            font-size: 1rem;
        }
        .invoice-list-subheader {
            font-size: 0.875rem;
            color: #6B7280;
            margin: 0;
        }
        .invoice-list-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            min-width: fit-content;
        }
        .invoice-list-actions button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            color: white;
            white-space: nowrap;
        }
        .invoice-list-actions button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .download-btn {
            background-color: #10B981;
        }
        .edit-draft-btn {
            background-color: #3B82F6;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .toggle-status-btn {
            background-color: #6B7280;
        }
        .item-dropdown {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .item-option:hover {
            background-color: #f3f4f6;
        }
        .main-content {
            flex: 1;
        }
        footer {
            margin-top: auto;
        }

        @media (max-width: 640px) {
            .header-logo {
                width: 40px;
                height: 40px;
            }
            .nav-btn {
                padding: 0.5rem !important;
                font-size: 0.875rem !important;
            }
            .container {
                padding: 1rem !important;
            }
            .grid-cols-12 {
                grid-template-columns: repeat(1, 1fr) !important;
            }
            .item-row {
                gap: 0.5rem !important;
            }
            .flex-wrap {
                flex-wrap: wrap;
            }
            .space-x-2 > * {
                margin-left: 0.5rem !important;
                margin-right: 0.5rem !important;
            }
            .p-4 {
                padding: 0.75rem !important;
            }
            .text-2xl {
                font-size: 1.25rem !important;
            }
            .text-4xl {
                font-size: 1.75rem !important;
            }
            .action-btn {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.875rem !important;
                border-radius: 0.5rem !important;
                transition: all 0.2s ease !important;
                min-width: auto !important;
                width: auto !important;
            }
            .action-btn:active {
                transform: scale(0.95) !important;
            }
            .download-btn {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.875rem !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 0.5rem !important;
                background-color: #10B981 !important;
                transition: all 0.2s ease !important;
                min-width: auto !important;
                width: auto !important;
            }
            .download-btn:active {
                transform: scale(0.95) !important;
                background-color: #059669 !important;
            }
            .download-btn span {
                display: inline-block !important;
            }
            .download-btn::before {
                display: none !important;
            }
            .item-row {
                grid-template-columns: 2fr 1fr 1fr 1fr auto !important;
                gap: 0.5rem !important;
                padding: 0.5rem !important;
                background-color: #F9FAFB !important;
                border-radius: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            .item-total {
                text-align: right !important;
                padding-right: 0.5rem !important;
                font-weight: 600 !important;
                color: #1F2937 !important;
            }
            .invoice-list-item {
                padding: 0.75rem !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.75rem !important;
            }
            .invoice-list-content {
                max-width: 100% !important;
                width: 100% !important;
            }
            .invoice-list-actions {
                width: 100% !important;
                justify-content: flex-start !important;
            }
            .invoice-list-actions button {
                padding: 0.375rem 0.75rem !important;
                font-size: 0.75rem !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="main-content">
        <header class="header-container">
            <div class="container mx-auto max-w-6xl px-4">
                <div class="header-content">
                    <img src="https://malkitsweetsandcatering.com/img/logo.png" alt="Malkit Sweets Logo" class="header-logo">
                    <div class="header-text">
                        <h1 class="header-title">Malkit Sweets</h1>
                        <p class="header-subtitle">Invoice Management System</p>
                    </div>
                </div>
            </div>
        </header>

        <div class="container mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">
            <div class="mb-6 bg-white rounded-lg shadow p-2 flex flex-wrap gap-2">
                <button data-view="create" class="nav-btn flex-1 py-2 px-4 rounded-md text-center font-medium bg-indigo-600 text-white">Create/Edit Invoice</button>
                <button data-view="drafts" class="nav-btn flex-1 py-2 px-4 rounded-md text-center font-medium bg-gray-200 text-gray-700">Drafts</button>
                <button data-view="invoices" class="nav-btn flex-1 py-2 px-4 rounded-md text-center font-medium bg-gray-200 text-gray-700">Sent Invoices</button>
                <button data-view="vendors" class="nav-btn flex-1 py-2 px-4 rounded-md text-center font-medium bg-gray-200 text-gray-700">Vendors</button>
                <button data-view="items" class="nav-btn flex-1 py-2 px-4 rounded-md text-center font-medium bg-gray-200 text-gray-700">Items</button>
            </div>

            <main>
                <!-- View 1: Invoice Generator Form -->
                <div id="view-create" class="view active bg-white p-4 sm:p-8 rounded-xl shadow-lg">
                    <form id="invoice-form">
                        <input type="hidden" id="draft-row-number">
                        <h2 id="form-title" class="text-2xl font-bold mb-6">Create New Invoice</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-6">
                            <div>
                                <label for="vendor" class="block text-sm font-medium">Vendor</label>
                                <select id="vendor" name="vendor" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg"></select>
                            </div>
                            <div>
                                <label for="date" class="block text-sm font-medium">Date</label>
                                <input type="text" id="date" name="date" required placeholder="MM/dd/yyyy" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg">
                            </div>
                            <div class="md:col-span-2">
                                <label for="notes" class="block text-sm font-medium">Notes</label>
                                <textarea id="notes" name="notes" rows="2" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg"></textarea>
                            </div>
                        </div>
                        <div class="border-t border-b border-gray-200 py-6">
                            <h3 class="text-lg font-semibold mb-4">Items</h3>
                            <div id="item-list" class="space-y-4"></div>
                            <button type="button" id="add-item-btn" class="mt-4 text-indigo-600 font-semibold hover:text-indigo-800">+ Add Item</button>
                        </div>
                        <div class="text-right mt-6 text-2xl font-bold">
                            <span>Grand Total: </span><span id="grand-total">$0.00</span>
                        </div>
                        <div class="mt-8 flex flex-wrap justify-between items-center gap-4">
                            <div class="action-buttons">
                                <button type="button" id="delete-draft-btn" class="hidden">Delete</button>
                                <button type="button" id="download-draft-btn" class="hidden">Download</button>
                                <button type="button" id="save-draft-btn">Save</button>
                            </div>
                            <button type="submit" id="generate-btn">Finalize & Send</button>
                        </div>
                    </form>
                </div>

                <!-- View 2: Drafts List -->
                <div id="view-drafts" class="view bg-white p-4 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6">Draft Invoices</h2>
                    <div id="draft-list" class="list-container space-y-3">
                        <div id="draft-loading" class="loading-spinner hidden"></div>
                    </div>
                </div>

                <!-- View 3: Sent Invoices List -->
                <div id="view-invoices" class="view bg-white p-4 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6">Sent Invoices</h2>
                    <div id="invoice-list" class="list-container space-y-3">
                        <div id="invoice-loading" class="loading-spinner hidden"></div>
                    </div>
                </div>

                <!-- View 4: Vendor Management -->
                <div id="view-vendors" class="view bg-white p-4 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Add a New Vendor</h2>
                    <form id="vendor-form" class="mb-6 pb-6 border-b border-gray-200 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="vendor-name" placeholder="Vendor Name" required class="w-full p-3 bg-gray-50 border rounded-lg">
                            <input type="email" id="vendor-email" placeholder="Vendor Email" required class="w-full p-3 bg-gray-50 border rounded-lg">
                        </div>
                        <input type="text" id="vendor-address" placeholder="Street Address" required class="w-full p-3 bg-gray-50 border rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="vendor-city" placeholder="City" required class="w-full p-3 bg-gray-50 border rounded-lg">
                            <input type="tel" id="vendor-phone" placeholder="Phone Number" required class="w-full p-3 bg-gray-50 border rounded-lg">
                        </div>
                        <button type="submit" id="add-vendor-btn" class="mt-2 w-full md:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Add Vendor</button>
                    </form>

                    <div id="vendor-list-container">
                        <h3 class="text-xl font-semibold mb-3">Current Vendor List</h3>
                        <div id="vendor-list-display" class="list-container space-y-3">
                            <div id="vendor-loading" class="loading-spinner hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- View 5: Item Management -->
                <div id="view-items" class="view bg-white p-4 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Add a New Item</h2>
                    <form id="item-form" class="mb-6 pb-6 border-b border-gray-200 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="item-name" placeholder="Item Name" required class="w-full p-3 bg-gray-50 border rounded-lg">
                            <input type="number" id="item-price" placeholder="Price" step="0.01" min="0" required class="w-full p-3 bg-gray-50 border rounded-lg">
                        </div>
                        <button type="submit" id="add-item-btn" class="mt-2 w-full md:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Add Item</button>
                    </form>

                    <div id="item-list-container">
                        <h3 class="text-xl font-semibold mb-3">Current Item List</h3>
                        <div id="item-list-display" class="list-container space-y-3">
                            <div id="item-loading" class="loading-spinner hidden"></div>
                        </div>
                    </div>
                </div>
            </main>
            
            <div id="toast" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>
            
            <!-- Edit Vendor Modal -->
            <div id="edit-vendor-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                     <h2 class="text-2xl font-bold mb-6">Edit Vendor</h2>
                    <form id="edit-vendor-form" class="space-y-4">
                        <input type="hidden" id="edit-vendor-row">
                        <div><label class="block text-sm font-medium">Vendor Name</label><input type="text" id="edit-vendor-name" required class="w-full p-3 bg-gray-50 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium">Email</label><input type="email" id="edit-vendor-email" required class="w-full p-3 bg-gray-50 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium">Address</label><input type="text" id="edit-vendor-address" required class="w-full p-3 bg-gray-50 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium">City</label><input type="text" id="edit-vendor-city" required class="w-full p-3 bg-gray-50 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium">Phone</label><input type="tel" id="edit-vendor-phone" required class="w-full p-3 bg-gray-50 border rounded-lg"></div>
                        <div class="flex items-center justify-between pt-4">
                            <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Save</button>
                            <button type="button" id="delete-vendor-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
                            <button type="button" id="cancel-edit-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Item Modal -->
            <div id="edit-item-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                    <h2 class="text-2xl font-bold mb-6">Edit Item</h2>
                    <form id="edit-item-form" class="space-y-4">
                        <input type="hidden" id="edit-item-row">
                        <div><label class="block text-sm font-medium">Item Name</label><input type="text" id="edit-item-name" required class="w-full p-3 bg-gray-50 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium">Price</label><input type="number" id="edit-item-price" step="0.01" min="0" required class="w-full p-3 bg-gray-50 border rounded-lg"></div>
                        <div class="flex items-center justify-between pt-4">
                            <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Save</button>
                            <button type="button" id="delete-item-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
                            <button type="button" id="cancel-edit-item-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-white border-t border-gray-200">
        <div class="container mx-auto max-w-6xl px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-2">
                    <img src="https://malkitsweetsandcatering.com/img/logo.png" alt="Malkit Sweets Logo" class="w-8 h-8">
                    <span class="text-gray-600">© <span id="current-year"></span> Malkit Sweets. All rights reserved.</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Set current year in footer
        document.getElementById('current-year').textContent = new Date().getFullYear();
        
        const BASE_URL = 'https://invoicegenerator-wine.onrender.com'; // Updated port
        const state = { 
            currentDraftRow: null, 
            vendors: [],
            items: [],
            isLoading: {
                drafts: false,
                invoices: false,
                vendors: false,
                items: false
            },
            currentPage: {
                drafts: 1,
                invoices: 1,
                vendors: 1,
                items: 1
            },
            hasMore: {
                drafts: true,
                invoices: true,
                vendors: true,
                items: true
            }
        };
        
        // DOM Elements
        const navButtons = document.querySelectorAll('.nav-btn');
        const views = document.querySelectorAll('.view');
        const toast = document.getElementById('toast');
        const invoiceForm = document.getElementById('invoice-form');
        const formTitle = document.getElementById('form-title');
        const draftRowInput = document.getElementById('draft-row-number');
        const vendorSelect = document.getElementById('vendor');
        const dateInput = document.getElementById('date');
        const notesInput = document.getElementById('notes');
        const itemListDiv = document.getElementById('item-list');
        const grandTotalSpan = document.getElementById('grand-total');
        const addItemBtn = document.getElementById('add-item-btn');
        const saveDraftBtn = document.getElementById('save-draft-btn');
        const generateBtn = document.getElementById('generate-btn');
        const formDeleteBtn = document.getElementById('delete-draft-btn');
        const draftListDiv = document.getElementById('draft-list');
        const invoiceListDiv = document.getElementById('invoice-list');
        const vendorForm = document.getElementById('vendor-form');
        const vendorListDisplay = document.getElementById('vendor-list-display');
        const editModal = document.getElementById('edit-vendor-modal');
        const editForm = document.getElementById('edit-vendor-form');
        const deleteVendorBtn = document.getElementById('delete-vendor-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editVendorNameInput = document.getElementById('edit-vendor-name');
        const editVendorEmailInput = document.getElementById('edit-vendor-email');
        const editVendorAddressInput = document.getElementById('edit-vendor-address');
        const editVendorCityInput = document.getElementById('edit-vendor-city');
        const editVendorPhoneInput = document.getElementById('edit-vendor-phone');
        const editVendorRowInput = document.getElementById('edit-vendor-row');
        const itemForm = document.getElementById('item-form');
        const itemListDisplay = document.getElementById('item-list-display');
        const editItemModal = document.getElementById('edit-item-modal');
        const editItemForm = document.getElementById('edit-item-form');
        const deleteItemBtn = document.getElementById('delete-item-btn');
        const cancelEditItemBtn = document.getElementById('cancel-edit-item-btn');

        const indianSweets = { 'Jalebi': 12.00, 'Ladoo': 18.50, 'Barfi': 22.00, 'Gulab Jamun': 15.00, 'Rasgulla': 14.00, 'Kaju Katli': 30.00, 'Mysore Pak': 20.00 };

        // --- Helper Functions ---
        const showToast = (message, isError = false) => {
            toast.textContent = message;
            toast.className = `fixed top-5 right-5 py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-600' : 'bg-gray-800'} text-white`;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        };

        const apiRequest = async (endpoint, method = 'GET', body = null) => {
            const options = { method, headers: { 'Content-Type': 'application/json' }};
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(`${BASE_URL}${endpoint}`, options);
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || `Request failed`);
            return result;
        };

        // --- View & State Management ---
        const switchView = (viewId) => {
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            navButtons.forEach(btn => {
                btn.classList.toggle('bg-indigo-600', btn.dataset.view === viewId);
                btn.classList.toggle('text-white', btn.dataset.view === viewId);
                btn.classList.toggle('bg-gray-200', btn.dataset.view !== viewId);
                btn.classList.toggle('text-gray-700', btn.dataset.view !== viewId);
            });
            if (viewId === 'create' && !state.currentDraftRow) {
                resetInvoiceForm();
            }
            if (viewId === 'drafts') fetchAndRenderDrafts();
            if (viewId === 'invoices') fetchAndRenderInvoices();
            if (viewId === 'vendors') fetchAndRenderVendors();
            if (viewId === 'items') fetchAndRenderItems();
        };

        const resetInvoiceForm = () => {
            invoiceForm.reset();
            state.currentDraftRow = null;
            draftRowInput.value = '';
            formTitle.textContent = 'Create New Invoice';
            formDeleteBtn.classList.add('hidden');
            document.getElementById('download-draft-btn').classList.add('hidden');
            itemListDiv.innerHTML = '';
            createItemRow();
            setInitialDate();
        };
        
        // --- Invoice Form Logic ---
        const calculateGrandTotal = () => {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                total += quantity * price;
            });
            grandTotalSpan.textContent = `$${total.toFixed(2)}`;
        };

        const createItemRow = (itemData = {}) => {
            const row = document.createElement('div');
            row.className = 'item-row grid grid-cols-12 gap-x-4 items-center';
            
            // Create item options from state.items
            const itemOptions = state.items.map(item => 
                `<div class="item-option p-2 hover:bg-gray-100 cursor-pointer" data-name="${item.name}" data-price="${item.price}">${item.name}</div>`
            ).join('');
            
            row.innerHTML = `
                <div class="col-span-5 relative">
                    <input type="text" class="item-search w-full p-2 border rounded" 
                           placeholder="Search items..." value="${itemData.item || ''}">
                    <div class="item-dropdown absolute w-full bg-white border rounded mt-1 max-h-48 overflow-y-auto z-10 hidden">
                        ${itemOptions}
                    </div>
                </div>
                <div class="col-span-2">
                    <input type="number" class="item-quantity w-full p-2 border rounded" 
                           value="${itemData.quantity || 1}" min="1">
                </div>
                <div class="col-span-2">
                    <input type="number" class="item-price w-full p-2 border rounded" 
                           value="${itemData.price || ''}" step="0.01" min="0">
                </div>
                <div class="col-span-2 text-right font-medium item-total">$0.00</div>
                <div class="col-span-1">
                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700">✖</button>
                </div>
            `;
            
            const searchInput = row.querySelector('.item-search');
            const dropdown = row.querySelector('.item-dropdown');
            const qtyInput = row.querySelector('.item-quantity');
            const priceInput = row.querySelector('.item-price');
            
            const updateRow = () => {
                const total = (parseFloat(priceInput.value) || 0) * (parseInt(qtyInput.value) || 0);
                row.querySelector('.item-total').textContent = `$${total.toFixed(2)}`;
                calculateGrandTotal();
            };

            // Show dropdown when clicking the search input
            searchInput.addEventListener('click', () => {
                // Refresh the dropdown options
                dropdown.innerHTML = state.items.map(item => 
                    `<div class="item-option p-2 hover:bg-gray-100 cursor-pointer" data-name="${item.name}" data-price="${item.price}">${item.name}</div>`
                ).join('');
                dropdown.classList.remove('hidden');
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!row.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Filter items as you type
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const options = dropdown.querySelectorAll('.item-option');
                
                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                });
                
                dropdown.classList.remove('hidden');
            });

            // Handle Enter key press
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchTerm = searchInput.value.toLowerCase();
                    const visibleOptions = Array.from(dropdown.querySelectorAll('.item-option'))
                        .filter(option => option.style.display !== 'none');
                    
                    if (visibleOptions.length > 0) {
                        const firstMatch = visibleOptions[0];
                        const name = firstMatch.dataset.name;
                        const price = firstMatch.dataset.price;
                        searchInput.value = name;
                        priceInput.value = price;
                        dropdown.classList.add('hidden');
                        updateRow();
                    }
                }
            });

            // Handle item selection
            dropdown.querySelectorAll('.item-option').forEach(option => {
                option.addEventListener('click', () => {
                    const name = option.dataset.name;
                    const price = option.dataset.price;
                    searchInput.value = name;
                    priceInput.value = price;
                    dropdown.classList.add('hidden');
                    updateRow();
                });
            });
            
            qtyInput.addEventListener('input', updateRow);
            priceInput.addEventListener('input', updateRow);
            row.querySelector('.remove-item-btn').addEventListener('click', () => {
                row.remove();
                calculateGrandTotal();
            });

            itemListDiv.appendChild(row);
            if(!itemData.price && searchInput.value) {
                const selectedItem = state.items.find(item => item.name === searchInput.value);
                if (selectedItem) {
                    priceInput.value = selectedItem.price;
                }
            }
            updateRow();
            return row;
        };

        // Add some custom styles
        const style = document.createElement('style');
        style.textContent = `
            .item-dropdown {
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .item-option:hover {
                background-color: #f3f4f6;
            }
        `;
        document.head.appendChild(style);

        const gatherFormData = () => {
            const vendorData = JSON.parse(vendorSelect.value);
            return {
                row_number: state.currentDraftRow,
                vendor_name: vendorData.name,
                vendor_email: vendorData.email,
                vendor_address: vendorData.address,
                vendor_city: vendorData.city,
                vendor_phone: vendorData.phone,
                date: dateInput.value,
                notes: notesInput.value,
                items: Array.from(document.querySelectorAll('.item-row')).map(row => ({
                    item: row.querySelector('.item-search').value,
                    quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
                    price: parseFloat(row.querySelector('.item-price').value) || 0,
                }))
            };
        };

        const loadDraftIntoForm = async (draft) => {
            try {
                // Fetch the complete draft data
                const completeDraft = await apiRequest(`/get-draft/${draft.row_number}`);
                
                // Clear form but preserve draft state
                invoiceForm.reset();
                state.currentDraftRow = completeDraft.row_number;
                draftRowInput.value = completeDraft.row_number;
                formTitle.textContent = `Editing Draft`;
                formDeleteBtn.classList.remove('hidden');
                document.getElementById('download-draft-btn').classList.remove('hidden');

                // Find and set the vendor
                const vendorValue = state.vendors.find(v => v.name === completeDraft.vendor_name && v.email === completeDraft.vendor_email);
                if(vendorValue) {
                    vendorSelect.value = JSON.stringify(vendorValue);
                }

                // Set other form fields
                dateInput.value = completeDraft.date || '';
                notesInput.value = completeDraft.notes || '';
                
                // Clear and recreate item rows
                itemListDiv.innerHTML = '';
                if (completeDraft.items && completeDraft.items.length > 0) {
                    completeDraft.items.forEach(item => {
                        const row = createItemRow(item);
                        // Ensure the price is set correctly
                        const priceInput = row.querySelector('.item-price');
                        const nameSelect = row.querySelector('.item-name');
                        if (item.price) {
                            priceInput.value = item.price;
                        } else if (nameSelect.value) {
                            priceInput.value = indianSweets[nameSelect.value] || 0;
                        }
                    });
                } else {
                    createItemRow();
                }
                
                // Switch to create view
                switchView('create');
                
                // Recalculate total
                calculateGrandTotal();
            } catch (error) {
                showToast(error.message, true);
            }
        };

        // --- Data Fetching & Rendering ---
        const showLoading = (type) => {
            const loadingElement = document.getElementById(`${type}-loading`);
            if (loadingElement) {
                loadingElement.classList.remove('hidden');
                state.isLoading[type] = true;
            }
        };

        const hideLoading = (type) => {
            const loadingElement = document.getElementById(`${type}-loading`);
            if (loadingElement) {
                loadingElement.classList.add('hidden');
                state.isLoading[type] = false;
            }
        };

        const fetchAndRenderVendors = async () => {
            try {
                showLoading('vendor');
                state.vendors = await apiRequest('/get-vendors');
                vendorSelect.innerHTML = '';
                vendorListDisplay.innerHTML = '<div id="vendor-loading" class="loading-spinner hidden"></div>';
                
                if (state.vendors.length > 0) {
                    state.vendors.forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(vendor); 
                        option.textContent = vendor.name;
                        vendorSelect.appendChild(option);

                        const vendorEl = document.createElement('div');
                        vendorEl.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                        vendorEl.innerHTML = `<div><p class="font-semibold">${vendor.name}</p><p class="text-sm text-gray-500">${vendor.phone || ''} - ${vendor.city || ''}</p></div><button class="edit-btn bg-blue-500 text-white text-sm font-bold py-1 px-3 rounded">Edit</button>`;
                        vendorEl.querySelector('.edit-btn').addEventListener('click', () => openEditModal(vendor));
                        vendorListDisplay.appendChild(vendorEl);
                    });
                } else {
                    vendorSelect.innerHTML = '<option disabled>No vendors found</option>';
                    vendorListDisplay.innerHTML = '<p>No vendors found. Add one below.</p>';
                }
            } catch(error) {
                showToast(error.message, true);
            } finally {
                hideLoading('vendor');
            }
        };

        const fetchAndRenderDrafts = async (isLoadMore = false) => {
            if (state.isLoading.drafts || !state.hasMore.drafts) return;
            
            try {
                showLoading('draft');
                const drafts = await apiRequest('/get-drafts');
                
                if (!isLoadMore) {
                    draftListDiv.innerHTML = '<div id="draft-loading" class="loading-spinner hidden"></div>';
                }
                
                if (drafts.length > 0) {
                    drafts.forEach(draft => {
                        const el = document.createElement('div');
                        el.className = 'invoice-list-item';
                        el.innerHTML = `
                            <div class="invoice-list-content">
                                <p class="invoice-list-header">Draft for: ${draft.vendor_name || 'N/A'}</p>
                                <p class="invoice-list-subheader">Date: ${draft.date || 'N/A'} at ${draft.formatted_time || 'N/A'}</p>
                            </div>
                            <div class="invoice-list-actions">
                                <button class="download-btn">Download</button>
                                <button class="edit-draft-btn">Edit</button>
                            </div>
                        `;
                        
                        // Add event listeners
                        el.querySelector('.download-btn').addEventListener('click', async () => {
                            try {
                                const formData = gatherFormData();
                                const response = await fetch(`${BASE_URL}/download-draft-preview`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(formData)
                                });
                                
                                if (!response.ok) {
                                    throw new Error('Failed to generate PDF');
                                }
                                
                                const blob = await response.blob();
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `DRAFT-${draft.row_number}.pdf`;
                                document.body.appendChild(a);
                                a.click();
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);
                            } catch (error) {
                                showToast(error.message, true);
                            }
                        });
                        
                        el.querySelector('.edit-draft-btn').addEventListener('click', () => loadDraftIntoForm(draft));
                        draftListDiv.appendChild(el);
                    });
                    
                    state.hasMore.drafts = drafts.length === 10;
                    state.currentPage.drafts++;
                } else {
                    if (!isLoadMore) {
                        draftListDiv.innerHTML = '<p class="text-gray-500">No drafts saved.</p>';
                    }
                    state.hasMore.drafts = false;
                }
            } catch(error) {
                showToast(error.message, true);
            } finally {
                hideLoading('draft');
            }
        };

        const fetchAndRenderInvoices = async (isLoadMore = false) => {
            if (state.isLoading.invoices || !state.hasMore.invoices) return;
            
            try {
                showLoading('invoice');
                const invoices = await apiRequest('/get-invoices');
                
                if (!isLoadMore) {
                    invoiceListDiv.innerHTML = '<div id="invoice-loading" class="loading-spinner hidden"></div>';
                }
                
                if (invoices.length > 0) {
                    invoices.forEach(inv => {
                        const statusColor = inv.status === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                        const el = document.createElement('div');
                        el.className = 'invoice-list-item';
                        el.innerHTML = `
                            <div class="invoice-list-content">
                                <p class="invoice-list-header">Invoice #${inv.invoice_num || 'N/A'} to ${inv.vendor_name}</p>
                                <p class="invoice-list-subheader">Date: ${inv.invoice_date} at ${inv.formatted_time || 'N/A'}, Total: $${inv.total || '0.00'}</p>
                            </div>
                            <div class="invoice-list-actions">
                                <span class="status-badge ${statusColor}">${inv.status || 'Due'}</span>
                                <button class="toggle-status-btn">${inv.status === 'Paid' ? 'Mark Due' : 'Mark Paid'}</button>
                            </div>
                        `;
                        
                        el.querySelector('.toggle-status-btn').addEventListener('click', async () => {
                            try {
                                const newStatus = inv.status === 'Paid' ? 'Due' : 'Paid';
                                const result = await apiRequest('/update-status', 'POST', { 
                                    row_number: inv.row_number,
                                    status: newStatus
                                });
                                
                                // Update UI immediately without reloading
                                const statusBadge = el.querySelector('.status-badge');
                                const toggleBtn = el.querySelector('.toggle-status-btn');
                                
                                // Update status badge
                                statusBadge.textContent = newStatus;
                                statusBadge.className = `status-badge ${newStatus === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
                                
                                // Update toggle button text based on new status
                                toggleBtn.textContent = newStatus === 'Paid' ? 'Mark Due' : 'Mark Paid';
                                
                                // Update the inv object for future toggles
                                inv.status = newStatus;
                                
                                showToast(result.message);
                            } catch (error) {
                                showToast(error.message, true);
                            }
                        });
                        invoiceListDiv.appendChild(el);
                    });
                    
                    state.hasMore.invoices = invoices.length === 10;
                    state.currentPage.invoices++;
                } else {
                    if (!isLoadMore) {
                        invoiceListDiv.innerHTML = '<p class="text-gray-500">No invoices sent.</p>';
                    }
                    state.hasMore.invoices = false;
                }
            } catch(error) {
                showToast(error.message, true);
            } finally {
                hideLoading('invoice');
            }
        };

        const fetchAndRenderItems = async () => {
            try {
                showLoading('item');
                state.items = await apiRequest('/get-sweets');
                itemListDisplay.innerHTML = '<div id="item-loading" class="loading-spinner hidden"></div>';
                
                if (state.items.length > 0) {
                    state.items.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'invoice-list-item';
                        itemEl.innerHTML = `
                            <div class="invoice-list-content">
                                <p class="invoice-list-header">${item.name}</p>
                                <p class="invoice-list-subheader">$${item.price}</p>
                            </div>
                            <div class="invoice-list-actions">
                                <button class="edit-item-btn bg-blue-500 text-white text-sm font-bold py-1 px-3 rounded">Edit</button>
                            </div>
                        `;
                        itemEl.querySelector('.edit-item-btn').addEventListener('click', () => openEditItemModal(item));
                        itemListDisplay.appendChild(itemEl);
                    });
                } else {
                    itemListDisplay.innerHTML = '<p>No items found. Add one below.</p>';
                }
            } catch(error) {
                showToast(error.message, true);
            } finally {
                hideLoading('item');
            }
        };

        // --- Event Handlers ---
        const handleSaveDraft = async () => {
            const payload = gatherFormData();
            if (payload.items.length === 0) {
                showToast('Add at least one item.', true);
                return;
            }
            try {
                const result = await apiRequest('/save-draft', 'POST', payload);
                showToast(result.message);
                resetInvoiceForm();
                switchView('create');
                fetchAndRenderDrafts();
            } catch(error) {
                showToast(error.message, true);
            }
        };

        const handleInvoiceSubmit = async (e) => {
            e.preventDefault();
            const payload = gatherFormData();
            if (payload.items.length === 0) {
                showToast('Add at least one item.', true);
                return;
            }
            try {
                const result = await apiRequest('/generate-invoice', 'POST', payload);
                showToast(result.message);
                resetInvoiceForm();
                switchView('invoices');
            } catch (error) {
                showToast(error.message, true);
            }
        };

        const updateInvoiceStatus = async (row_number, status) => {
            try {
                const result = await apiRequest('/update-status', 'POST', { row_number, status });
                showToast(result.message);
                fetchAndRenderInvoices();
            } catch(error) { showToast(error.message, true); }
        };
        
        const handleDeleteDraft = async () => {
            if (!state.currentDraftRow || !confirm('Delete this draft?')) return;
            try {
                const result = await apiRequest('/delete-draft', 'POST', { row_number: state.currentDraftRow });
                showToast(result.message);
                resetInvoiceForm();
            } catch(error) { showToast(error.message, true); }
        };
        
        const openEditModal = (vendor) => {
             editVendorRowInput.value = vendor.row_number;
             editVendorNameInput.value = vendor.name;
             editVendorEmailInput.value = vendor.email;
             editVendorAddressInput.value = vendor.address || '';
             editVendorCityInput.value = vendor.city || '';
             editVendorPhoneInput.value = vendor.phone || '';
             editModal.style.display = 'flex';
        };
        const closeEditModal = () => editModal.style.display = 'none';

        const handleAddVendor = async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('vendor-name').value,
                email: document.getElementById('vendor-email').value,
                address: document.getElementById('vendor-address').value,
                city: document.getElementById('vendor-city').value,
                phone: document.getElementById('vendor-phone').value
            };
            try {
                await apiRequest('/add-vendor', 'POST', payload);
                showToast('Vendor added!');
                vendorForm.reset();
                fetchAndRenderVendors();
            } catch(error) { showToast(error.message, true); }
        };
        
        const handleEditVendor = async(e) => {
            e.preventDefault();
            const payload = {
                row_number: editVendorRowInput.value,
                name: editVendorNameInput.value,
                email: editVendorEmailInput.value,
                address: editVendorAddressInput.value,
                city: editVendorCityInput.value,
                phone: editVendorPhoneInput.value
            };
            try {
                await apiRequest('/edit-vendor', 'POST', payload);
                showToast('Vendor updated!');
                closeEditModal();
                fetchAndRenderVendors();
            } catch(error) { showToast(error.message, true); }
        };

        const handleDeleteVendor = async () => {
            if (!confirm('Are you sure?')) return;
            try {
                await apiRequest('/delete-vendor', 'POST', {row_number: editVendorRowInput.value});
                showToast('Vendor deleted.');
                closeEditModal();
                fetchAndRenderVendors();
            } catch(error) { showToast(error.message, true); }
        };

        const openEditItemModal = (item) => {
            document.getElementById('edit-item-row').value = item.row_number;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-price').value = item.price;
            editItemModal.style.display = 'flex';
        };

        const closeEditItemModal = () => editItemModal.style.display = 'none';

        const handleAddItem = async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('item-name').value,
                price: parseFloat(document.getElementById('item-price').value)
            };
            try {
                await apiRequest('/add-sweet', 'POST', payload);
                showToast('Item added!');
                itemForm.reset();
                await fetchAndRenderItems();
                // Update the item dropdowns in the invoice form
                const rows = document.querySelectorAll('.item-row');
                rows.forEach(row => {
                    const select = row.querySelector('.item-name');
                    const currentValue = select.value;
                    const currentPrice = row.querySelector('.item-price').value;
                    select.innerHTML = '<option value="">Select an item</option>' + 
                        state.items.map(item => 
                            `<option value="${item.name}" data-price="${item.price}" ${currentValue === item.name ? 'selected' : ''}>${item.name}</option>`
                        ).join('');
                    if (currentValue) {
                        select.value = currentValue;
                        row.querySelector('.item-price').value = currentPrice;
                    }
                });
            } catch(error) { 
                showToast(error.message, true); 
            }
        };

        const handleEditItem = async(e) => {
            e.preventDefault();
            const payload = {
                row_number: document.getElementById('edit-item-row').value,
                name: document.getElementById('edit-item-name').value,
                price: parseFloat(document.getElementById('edit-item-price').value)
            };
            try {
                await apiRequest('/edit-sweet', 'POST', payload);
                showToast('Item updated!');
                closeEditItemModal();
                await fetchAndRenderItems();
                // Update the item dropdowns in the invoice form
                const rows = document.querySelectorAll('.item-row');
                rows.forEach(row => {
                    const select = row.querySelector('.item-name');
                    const currentValue = select.value;
                    const currentPrice = row.querySelector('.item-price').value;
                    select.innerHTML = '<option value="">Select an item</option>' + 
                        state.items.map(item => 
                            `<option value="${item.name}" data-price="${item.price}" ${currentValue === item.name ? 'selected' : ''}>${item.name}</option>`
                        ).join('');
                    if (currentValue) {
                        select.value = currentValue;
                        row.querySelector('.item-price').value = currentPrice;
                    }
                });
            } catch(error) { 
                showToast(error.message, true); 
            }
        };

        const handleDeleteItem = async () => {
            if (!confirm('Are you sure you want to delete this item?')) return;
            try {
                await apiRequest('/delete-sweet', 'POST', {
                    row_number: document.getElementById('edit-item-row').value
                });
                showToast('Item deleted.');
                closeEditItemModal();
                fetchAndRenderItems();
            } catch(error) { 
                showToast(error.message, true); 
            }
        };

        // --- Initialization ---
        const setInitialDate = () => {
            const today = new Date();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const year = today.getFullYear();
            dateInput.value = `${month}/${day}/${year}`;
        };

        // Add scroll event listeners for infinite scroll
        const setupInfiniteScroll = () => {
            const draftContainer = document.getElementById('draft-list');
            const invoiceContainer = document.getElementById('invoice-list');
            const vendorContainer = document.getElementById('vendor-list-display');

            draftContainer.addEventListener('scroll', () => {
                if (draftContainer.scrollTop + draftContainer.clientHeight >= draftContainer.scrollHeight - 100) {
                    fetchAndRenderDrafts(true);
                }
            });

            invoiceContainer.addEventListener('scroll', () => {
                if (invoiceContainer.scrollTop + invoiceContainer.clientHeight >= invoiceContainer.scrollHeight - 100) {
                    fetchAndRenderInvoices(true);
                }
            });
        };

        // Update initialization
        const initializeApp = async () => {
            navButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
            addItemBtn.addEventListener('click', () => createItemRow());
            invoiceForm.addEventListener('submit', handleInvoiceSubmit);
            saveDraftBtn.addEventListener('click', handleSaveDraft);
            formDeleteBtn.addEventListener('click', handleDeleteDraft);
            vendorForm.addEventListener('submit', handleAddVendor);
            editForm.addEventListener('submit', handleEditVendor);
            deleteVendorBtn.addEventListener('click', handleDeleteVendor);
            cancelEditBtn.addEventListener('click', closeEditModal);
            itemForm.addEventListener('submit', handleAddItem);
            editItemForm.addEventListener('submit', handleEditItem);
            deleteItemBtn.addEventListener('click', handleDeleteItem);
            cancelEditItemBtn.addEventListener('click', closeEditItemModal);

            setupInfiniteScroll();
            await fetchAndRenderVendors();
            await fetchAndRenderItems(); // Load items immediately
            resetInvoiceForm();
        };

        // Add download draft handler
        document.getElementById('download-draft-btn').addEventListener('click', async () => {
            if (!state.currentDraftRow) return;
            try {
                const formData = gatherFormData();
                const response = await fetch(`${BASE_URL}/download-draft-preview`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate PDF');
                }
                
                // Convert the response to a blob
                const blob = await response.blob();
                
                // Create a download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `DRAFT-${state.currentDraftRow}.pdf`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                showToast(error.message, true);
            }
        });

        initializeApp();
    });
    </script>
</body>
</html>
